<!DOCTYPE html>
<script src="../dist/hello-indexeddb.js"></script>
<script>
(async function() {
    let idb = new HelloIndexedDB({
        name: 'mydb',
        version: 2,
        stores: [
            {
                name: 'departs',
                primaryKey: 'id',
            },
            {
                name: 'students',
                primaryKey: 'id',
                indexes: [
                    {
                        name: 'id',
                        key: 'id',
                        unique: true,
                    },
                    {
                        name: 'name',
                    },
                    {
                        name: 'age',
                    },
                ],
            },
        ],
        use: 'students',
    })

    // test add
    try {
        await idb.add({ id: '1', name: 'toda', age: 10 })
        console.log('[test:] add successfully.')
    }
    catch(e) {
        console.error('[test:] add error.', e)
    }

    // test put
    try {
        await idb.put({ id: '2', name: 'sood', age: 21, time: new Date() })
        console.log('[test:] put successfully.')
    }
    catch(e) {
        console.error('[test:] put error.', e)
    }

    // test delete
    try {
        await idb.delete('1')
        console.log('[test:] delete successfully.')
    }
    catch(e) {
        console.error('[test:] delete error.', e)
    }

    // test get
    let obj2 = await idb.get('2')
    console.log('[test:] get successfully.', obj2)

    await idb.put({ id: '3', name: 'tomy', age: 10 })
    await idb.put({ id: '4', name: 'goda', age: 10 })

    // test find
    try {
        let obj = await idb.find('age', 10)
        console.log('[test:] find successfully.', obj)
    }
    catch(e) {
        console.error('[test:] find error.', e)
    }

    // test query
    try {
        let objs = await idb.query('age', 10)
        console.log('[test:] query successfully.', objs)
    }
    catch(e) {
        console.error('[test:] query error.', e)
    }

    // test query compare
    try {
        let objs = await idb.query('age', 15, '>')
        console.log('[test:] query >15 successfully.', objs)
    }
    catch(e) {
        console.error('[test:] query error.', e)
    }

    // test select
    try {
        let objs = await idb.select([
            { key: 'age', value: 22, compare: '>', optional: true },
            { key: 'age', value: 10, compare: '=', optional: true },
        ])
        console.log('[test:] select successfully.', objs)
    }
    catch(e) {
        console.error('[test:] select error.', e)
    }

    // test all
    await idb.put({ id: '5', name: 'tiny', age: 12 })
    try {
        let objs = await idb.all()
        console.log('[test:] all successfully.', objs)
    }
    catch(e) {
        console.error('[test:] all error.', e)
    }

    // test count
    try {
        let objs = await idb.count()
        console.log('[test:] count successfully.', objs)
    }
    catch(e) {
        console.error('[test:] count error.', e)
    }

    // test use
    let idb2 = idb.use('departs')
    await idb2.put({ id: '1', name: 'doge' })
    let v = await idb2.all()
    console.log('[test:] use.', v)

    // test put multiple
    let promises = []
    promises.push(
        idb.put({ id: '20', name: 'tony', age: 23 })
    )
    promises.push(
        idb.put({ id: '21', name: 'sona', age: 23 })
    )
    promises.push(
        idb.put({ id: '22', name: 'godt', age: 23 })
    )
    await Promise.all(promises)
    let objs = await idb.query('age', 23)
    console.log('[test:] multiple put successfully.', objs)

    // test each
    await idb.each((v, i, next, stop) => {
        console.log('[test:] each', i, v)
        if (i === 4) {
            stop()
            return
        }
        next()
    })

    // test async
    setTimeout(async () => {
        let obj = await idb.get('22')
        console.log('[test:] async get successfully.', obj)
    }, 500)

    // test 
    // let idbx = new HelloIndexedDB()
    // await idbx.put({ name: 'xxx' })
    
})();
</script>
